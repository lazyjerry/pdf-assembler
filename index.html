<!DOCTYPE html>
<html lang="zh-TW">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>åˆç´„/å ±åƒ¹å–®/è¦æ ¼æ›¸åŒ…èµ·ä¾†</title>
		<!-- è¼‰å…¥ Bootstrap 5 CSS -->
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
		<!-- è¼‰å…¥ PDF-LIB åº« -->
		<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
		<!-- è¼‰å…¥ SortableJS -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
		<style>
			.drop-zone {
      border: 2px dashed #cccccc;
      border-radius: 5px;
      padding: 30px;
      text-align: center;
      color: #cccccc;
      cursor: pointer;
    }
    .drop-zone.dragover {
      background-color: #f8f9fa;
      border-color: #0d6efd;
      color: #0d6efd;
    }
    .file-list {
      list-style: none;
      padding-left: 0;
    }
    .file-list li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      margin-bottom: 4px;
      background-color: #e9ecef;
      border-radius: 4px;
      cursor: move;
    }
    .drag-handle {
      margin-right: 8px;
      cursor: move;
      font-size: 1.2rem;
      color: #6c757d;
    }
    .delete-btn {
      border: none;
      background: none;
      cursor: pointer;
      font-size: 1.2rem;
      line-height: 1;
      color: #dc3545;
    }
  </style>
	</head>

	<body>
		<div class="container py-5">
			<h1 class="mb-4">åˆç´„/å ±åƒ¹å–®/è¦æ ¼æ›¸åŒ…èµ·ä¾†</h1>
			<!-- æ‹–æ›³ä¸Šå‚³å€å¡Š -->
			<div id="drop-zone" class="drop-zone mb-3">
				æ‹–æ›³ PDF æ–‡ä»¶åˆ°é€™è£¡ï¼Œæˆ–é»æ“Šä»¥ä¸Šå‚³
			</div>
			<!-- éš±è—çš„æª”æ¡ˆä¸Šå‚³ input -->
			<input type="file" id="pdfInput" multiple accept="application/pdf" style="display:none;">
			<!-- é¡¯ç¤ºæª”æ¡ˆæ¸…å–® -->
			<ul id="fileList" class="file-list mb-3"></ul>
			<!-- è¼¸å…¥åˆä½µå¾Œ PDF æª”ååŠæ“ä½œæŒ‰éˆ• -->
			<div class="d-flex align-items-center mb-3">
				<input type="text" id="pdfName" class="form-control me-2" placeholder="è¼¸å…¥ PDF æª”å (ä¸å«å‰¯æª”å)" style="max-width: 250px;">
				<button id="mergeBtn" class="btn btn-primary me-2">åˆä½µ PDF</button>
				<!-- ä¸‹è¼‰æŒ‰éˆ•ä»¥ <a> å…ƒç´ å¯¦ç¾ -->
				<a id="downloadBtn" class="btn btn-success" style="display: none;">ä¸‹è¼‰ PDF</a>
			</div>
			<!-- é¡¯ç¤ºç›®å‰å‹•ä½œè¨Šæ¯ -->
			<div id="result" class="mt-4 text-muted" style="display: none;"></div>
		</div>
		<script>
		const dropZone = document.getElementById('drop-zone');
		const pdfInput = document.getElementById('pdfInput');
		const fileListUL = document.getElementById('fileList');
		const mergeBtn = document.getElementById('mergeBtn');
		const downloadBtn = document.getElementById('downloadBtn');
		const pdfNameInput = document.getElementById('pdfName');
		const resultDiv = document.getElementById('result');

		// ç”¨ä¾†å„²å­˜ä¸Šå‚³çš„æª”æ¡ˆï¼Œä¸¦é™„åŠ å”¯ä¸€ id
		let files = [];
		let fileIdCounter = 0;

		// æ›´æ–°å‹•ä½œè¨Šæ¯
		function updateResult(message) {
			resultDiv.style.display = 'block';
			resultDiv.textContent = message;
		}

		// æ›´æ–°æª”æ¡ˆæ¸…å–®é¡¯ç¤ºï¼Œä¸¦åŠ å…¥é †åºç·¨è™Ÿã€æ‹–æ›³åœ–ç¤ºèˆ‡åˆªé™¤æŒ‰éˆ•
		function updateFileList() {
			fileListUL.innerHTML = '';
			files.forEach((fileObj, index) => {
				const li = document.createElement('li');
				li.setAttribute('data-id', fileObj.id);

				// æ‹–æ›³åœ–ç¤º
				const dragHandle = document.createElement('span');
				dragHandle.classList.add('drag-handle');
				dragHandle.textContent = 'â˜°';
				li.appendChild(dragHandle);

				// é †åºç·¨è™Ÿèˆ‡æª”æ¡ˆåç¨±
				const span = document.createElement('span');
				span.textContent = `#${index + 1} ${fileObj.file.name}`;
				li.appendChild(span);

				// åˆªé™¤æŒ‰éˆ•
				const deleteBtn = document.createElement('button');
				deleteBtn.classList.add('delete-btn');
				deleteBtn.innerHTML = 'ğŸ—‘ï¸';
				deleteBtn.addEventListener('click', (e) => {
					e.stopPropagation();
					files = files.filter(f => f.id !== fileObj.id);
					updateFileList();
					updateResult(`å·²ç§»é™¤ ${fileObj.file.name}`);
					// è‹¥æª”æ¡ˆæœ‰è®Šå‹•ï¼Œéš±è—ä¸‹è¼‰æŒ‰éˆ•
					downloadBtn.style.display = 'none';
				});
				li.appendChild(deleteBtn);

				fileListUL.appendChild(li);
			});
			updateResult(`ç›®å‰å·²é¸æ“‡ ${files.length} å€‹æª”æ¡ˆ`);
			// æª”æ¡ˆæ•¸é‡æˆ–é †åºè®Šæ›´æ™‚éš±è—ä¸‹è¼‰æŒ‰éˆ•
			downloadBtn.style.display = 'none';
		}

		// åˆå§‹åŒ– SortableJS
		Sortable.create(fileListUL, {
			animation: 150,
			handle: '.drag-handle',
			onEnd: function(evt) {
				const newOrder = [];
				fileListUL.querySelectorAll('li').forEach(li => {
					const id = parseInt(li.getAttribute('data-id'));
					const fileObj = files.find(f => f.id === id);
					if (fileObj) newOrder.push(fileObj);
				});
				files = newOrder;
				updateFileList();
				updateResult('æª”æ¡ˆé †åºå·²æ›´æ–°');
			}
		});

		// é»æ“Šæ‹–æ›³å€å¡Šæ™‚è§¸ç™¼éš±è—çš„æª”æ¡ˆä¸Šå‚³ input
		dropZone.addEventListener('click', () => {
			pdfInput.click();
		});

		// æª¢æŸ¥æª”æ¡ˆé¡å‹æ˜¯å¦ç‚º PDFï¼ˆæª¢æŸ¥ MIME èˆ‡å‰¯æª”åï¼‰
		function isValidPDF(file) {
			const isPdfMime = file.type === 'application/pdf';
			const isPdfExt = file.name.toLowerCase().endsWith('.pdf');
			return isPdfMime || isPdfExt;
		}

		// è™•ç†æª”æ¡ˆé¸æ“‡
		pdfInput.addEventListener('change', (e) => {
			const selectedFiles = Array.from(e.target.files);
			addFiles(selectedFiles);
		});

		// è™•ç†æ‹–æ›³
		dropZone.addEventListener('dragover', (e) => {
			e.preventDefault();
			dropZone.classList.add('dragover');
		});
		dropZone.addEventListener('dragleave', (e) => {
			dropZone.classList.remove('dragover');
		});
		dropZone.addEventListener('drop', (e) => {
			e.preventDefault();
			dropZone.classList.remove('dragover');
			if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
				const droppedFiles = Array.from(e.dataTransfer.files);
				addFiles(droppedFiles);
				pdfInput.files = e.dataTransfer.files; // åŒæ­¥æ›´æ–°éš±è— inputï¼ˆéå¿…è¦ï¼‰
				e.dataTransfer.clearData();
			}
		});

		// æ–°å¢æª”æ¡ˆåˆ°å…¨åŸŸé™£åˆ—ï¼Œé PDF å‰‡è·³è­¦å‘Š
		function addFiles(selectedFiles) {
			selectedFiles.forEach(file => {
				if (!isValidPDF(file)) {
					alert(`æª”æ¡ˆ ${file.name} ä¸æ˜¯ PDF æ ¼å¼ï¼Œè«‹é¸æ“‡ PDF æª”æ¡ˆã€‚`);
					return;
				}
				const exists = files.some(f => f.file.name === file.name && f.file.size === file.size);
				if (!exists) {
					files.push({ id: fileIdCounter++, file });
				}
			});
			updateFileList();
		}

		// åˆä½µ PDF
		mergeBtn.addEventListener('click', async (e) => {
			if (files.length === 0) {
				alert('è«‹é¸æ“‡è‡³å°‘ä¸€å€‹ PDF æ–‡ä»¶');
				return;
			}

			// æª¢æŸ¥è¼¸å…¥çš„ PDF æª”åï¼Œè‹¥æ²’æœ‰å‰‡é è¨­ä½¿ç”¨ç•¶å‰å¹´æœˆæ—¥
			let pdfName = pdfNameInput.value.trim();
			if (!pdfName) {
				const now = new Date();
				const year = now.getFullYear();
				const month = (now.getMonth() + 1).toString().padStart(2, '0');
				const day = now.getDate().toString().padStart(2, '0');
				pdfName = `${year}-${month}-${day}`;
				pdfNameInput.value = pdfName;
			}
			const fullPdfName = pdfName + '.pdf';

			updateResult('æ­£åœ¨åˆä½µ PDF â€¦');
			const { PDFDocument } = PDFLib;
			const mergedPdf = await PDFDocument.create();

			for (let fileObj of files) {
				const arrayBuffer = await fileObj.file.arrayBuffer();
				const pdf = await PDFDocument.load(arrayBuffer);
				const pages = await mergedPdf.copyPages(pdf, pdf.getPageIndices());
				pages.forEach(page => mergedPdf.addPage(page));
			}

			const mergedPdfBytes = await mergedPdf.save();
			const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' });
			const url = URL.createObjectURL(blob);

			downloadBtn.href = url;
			downloadBtn.setAttribute('download', fullPdfName);
			downloadBtn.style.display = 'inline-block';
			updateResult('PDF åˆä½µå®Œæˆï¼');
		});

		// ç•¶é»æ“Šä¸‹è¼‰ PDF æ™‚ï¼Œä¹Ÿé¡¯ç¤ºè¨Šæ¯
		downloadBtn.addEventListener('click', () => {
			updateResult('æ­£åœ¨ä¸‹è¼‰ PDF â€¦');
		});
		</script>
	</body>

</html>